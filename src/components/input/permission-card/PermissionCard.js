import axios from 'axios';
import React, { useState, useEffect } from 'react';
import {
    Row, Col, Card, Button
} from 'react-bootstrap';

import PermissionContent from './PermissionContent';

const PermissionCard = ({inputs, setInputs}) => {
    const [permissionStates, setPermissionStates] = useState({});
    const [permissionNames, setPermissionNames] = useState([]);

    const [permLoad, setPermLoad] = useState(true);

    useEffect(() => {
        permLoad && axios.get(`http://localhost:5000/getPermissions`)
            .then(data => {
                setPermissionNames(data.data.permissions);
                console.log("permission count : " + data.data.permissions.length);
            }).then(() => {
                setPermLoad(false);
            });
        setPermissionStates(() => {
            let temp = {};
            for (let i = 0; i < permissionNames.length; ++i) temp[i] = false;
            return temp;
        });
    }, [permissionNames]);

    const handleCreateInputManually = () => {
        let temp = "";
        Object.keys(permissionStates).forEach(key => {
            temp = temp.concat(permissionStates[key] ? '1' : '0');
        });
        let xinput = inputs.concat({ 
            string: temp,
            mode: 'by ManualSwitch',
            time: Date.now() 
        });
        setInputs(xinput);
    }

    const resetStates = () => {
        setPermissionStates(() => {
            let temp = {};
            for (let i = 0; i < permissionNames.length; ++i) temp[i] = false;
            return temp;
        });
    }

    return (
        !permLoad && <div className="permission-card">
            <Card style={{
                width: '90%',
                marginTop: '4vh',
                fontSize: '14px',
                height: '74vh',
                overflowY: 'scroll',
                borderRadius: '0px',
                border: '2px solid #999',
                borderRight: '0px'
            }}>
                <Card.Body>
                    <Row style={{ marginBottom: '2vh' }}>
                        <Col xs={9} sm={9} md={9} xl={9}><b>Permission</b></Col>
                        <Col xs={3} sm={3} md={3} xl={3}><b>State</b></Col>
                    </Row>
                    <hr style={{color: '#999', opacity: '1'}}/>
                    {
                        permissionNames.length > 0 && permissionNames.map((p, i) => {
                            return <PermissionContent key={i} permission={[p, permissionStates[i], i]} changePermissions={setPermissionStates} allPermissions={permissionStates}/>
                        })
                    }
                </Card.Body>
            </Card>
            <Row>
                <Col sm={8} md={8} lg={8} xl={8}><Button variant='dark' onClick={handleCreateInputManually} block style={{
                    // maxWidth: '90%',
                    border: '1px solid #999',
                    marginTop: '2vh',
                    borderRadius: '0px'
                }}>Add</Button></Col>
                <Col><Button variant='dark' onClick={resetStates} block style={{
                    maxWidth: '67.5%',
                    border: '1px solid #999',
                    marginTop: '2vh',
                    borderRadius: '0px',
                    // float: 'right'
                }}>Reset</Button></Col>
            </Row>
        </div>
    )
}

export default PermissionCard
